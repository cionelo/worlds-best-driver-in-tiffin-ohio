<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tiffin Runner — World’s Best Driver (v3)</title>
  <meta property="og:url" content="og-homepage.html" />
  <style>
    html,body{height:100%;}
    body{margin:0;background:#000;color:#fff;font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
    .wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    canvas{display:block;background:#000;touch-action:manipulation}
    .hud{position:fixed;inset:0;pointer-events:none;display:flex;align-items:flex-start;justify-content:space-between;padding:12px 16px;font-weight:600;letter-spacing:.5px;text-shadow:0 1px 2px rgba(0,0,0,.6)}
    .hud .right{display:flex;gap:12px}
    .pill{background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:999px}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;text-align:center;padding:24px}
    .overlay.show{display:flex}
    .card{background:#111;border:1px solid #333;padding:18px 20px;border-radius:14px;max-width:520px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .card h2{margin:.2rem 0 0;font-size:1.25rem}
    .card p{opacity:.9;margin:.35rem 0 .75rem}
    .card .btns{display:flex;gap:10px;justify-content:center;margin-top:.5rem}
    button{background:#fff;border:0;border-radius:12px;padding:.6rem 1rem;cursor:pointer;font-weight:700}
    .tip{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);opacity:.85;font-size:.9rem}
    .banner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;background:rgba(0,0,0,.7);padding:.6rem .8rem;border-radius:10px;font-weight:700;pointer-events:none}
  </style>
</head>
<body>
  <div class="wrap"><canvas id="game"></canvas></div>
  <div class="hud">
    <div class="left pill">World’s Best Driver — Tiffin Run</div>
    <div class="right">
      <div class="pill">Time: <span id="time">0.0</span>s</div>
      <div class="pill">Score: <span id="score">0</span></div>
    </div>
  </div>
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-live="assertive">
    <div class="card">
      <h2 id="title">Game Over</h2>
      <p id="subtitle">You hit an obstacle.</p>
      <div class="btns"><button id="retry">Restart (R)</button></div>
    </div>
  </div>
  <div class="tip">Space/▲/Tap to Jump — Avoid stalks & potholes — Survive 30s to win</div>
  <div id="banner" class="banner">Loading…</div>

  <script>
  (function(){
    // Small helper to safely read og:url
    function getHomeURL(){
      var tags = document.getElementsByTagName('meta');
      for (var i=0;i<tags.length;i++){
        if (tags[i].getAttribute('property') === 'og:url') return tags[i].getAttribute('content') || '/';
      }
      return '/';
    }
    var HOME_URL = getHomeURL();

    var WIN_KEY = 'wbd_won_v1'; // also set query param as backup

    var canvas = document.getElementById('game');
    var ctx = canvas.getContext('2d');
    var banner = document.getElementById('banner');

    // Images
    function img(src){
      var im = new Image();
      im.crossOrigin = 'anonymous';
      im.src = src;
      return im;
    }
    var bgImg = img('tiffin-ohio-road-side-cornfields.jpg');
    var playerImg = img('the-worlds-best-driver-is-in-tiffin-ohio.png');
    var cornImg = img('pixelated-corn-in-tiffin-ohio.jpg'); // chroma-keyed

    var DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    function resize(){
      var w = Math.min(window.innerWidth || 800, 1100);
      var h = Math.min(window.innerHeight || 400, 520);
      if (w < 300) w = 800; if (h < 200) h = 400;
      canvas.width = Math.floor(w * DPR);
      canvas.height = Math.floor(h * DPR);
      canvas.style.width = w+'px';
      canvas.style.height = h+'px';
      computeGround(); resetPlayer();
    }
    window.addEventListener('resize', resize, false);
    resize();

    var groundY = 0;
    function computeGround(){ groundY = Math.max(80, canvas.height * 0.78); }

    var player = { x: 0, y: 0, w: 90*DPR, h: 90*DPR, vy: 0, onGround: true };
    function resetPlayer(){
      player.x = canvas.width*0.18;
      player.w = 90*DPR; player.h = 90*DPR;
      player.y = groundY - player.h + 2;
      player.vy = 0; player.onGround = true;
    }

    var speed = 400 * DPR, gravity = 2600 * DPR, jumpVy = -900 * DPR;
    var obstacles = [], nextSpawn = 0;

    var cornSprite = null;
    function makeChromaSprite(img){
      try {
        var w = img.naturalWidth, h = img.naturalHeight;
        if (!w || !h) return null;
        var off = document.createElement('canvas');
        off.width = w; off.height = h;
        var octx = off.getContext('2d');
        octx.drawImage(img, 0, 0);
        var data = octx.getImageData(0,0,w,h);
        var px = data.data;
        for (var i=0;i<px.length;i+=4){
          var r=px[i], g=px[i+1], b=px[i+2];
          var max = Math.max(r,g,b), min = Math.min(r,g,b);
          var sat = max ? (max-min)/max : 0;
          var val = max/255;
          if (sat < 0.12 && val > 0.75) px[i+3] = 0;
        }
        octx.putImageData(data,0,0);
        return off;
      } catch(e){
        console.warn('Chroma-key failed; using source image.', e);
        return null;
      }
    }
    function ensureCornSprite(){
      if (cornSprite !== null) return cornSprite;
      cornSprite = makeChromaSprite(cornImg) || cornImg;
      return cornSprite;
    }

    function spawnObstacle(now){
      var type = Math.random() < 0.6 ? 'corn' : 'pothole';
      if (type === 'corn'){
        var sprite = ensureCornSprite();
        var aspect = (sprite && sprite.width && sprite.height) ? (sprite.width/sprite.height) : (40/100);
        var baseH = (70 + Math.random()*70) * DPR;
        var w = baseH * aspect, h = baseH;
        obstacles.push({type:type, x: canvas.width + 20*DPR, w:w, h:h, y: groundY - h});
      } else {
        var w2 = (70 + Math.random()*60) * DPR;
        var h2 = (18 + Math.random()*10) * DPR;
        obstacles.push({type:type, x: canvas.width + 20*DPR, w:w2, h:h2, y: groundY - h2 + Math.max(0, (player.h*0.05))});
      }
      nextSpawn = now + 700 + Math.random()*1000;
    }

    var startTime=0, now=0, last=0, elapsed=0, score=0, running=false;

    var timeEl = document.getElementById('time');
    var scoreEl = document.getElementById('score');
    var overlay = document.getElementById('overlay');
    var titleEl = document.getElementById('title');
    var subEl = document.getElementById('subtitle');
    var retryBtn = document.getElementById('retry');

    function start(){
      obstacles.length = 0;
      speed = 400 * DPR; gravity = 2600 * DPR; jumpVy = -900 * DPR;
      resetPlayer();
      startTime = performance.now(); last = startTime; now = startTime;
      elapsed = 0; score = 0;
      overlay.classList.remove('show');
      banner.textContent = '';
      banner.style.display = 'none';
      running = true;
      requestAnimationFrame(loop);
    }

    function win(){
      // mark win in localStorage AND via query param on redirect
      try { localStorage.setItem('wbd_won_v1', '1'); } catch(e){}
      var sep = HOME_URL.indexOf('?') === -1 ? '?' : '&';
      setTimeout(function(){ window.location.href = HOME_URL + sep + 'won=1'; }, 1600);
    }
    function die(why){
      running = false;
      titleEl.textContent = 'Game Over';
      subEl.textContent = (why === 'pothole') ? 'You hit a pothole.' : 'You hit a corn stalk.';
      overlay.classList.add('show');
    }

    function jump(){
      if (!running) return;
      if (player.onGround){ player.vy = jumpVy; player.onGround = false; }
    }
    window.addEventListener('keydown', function(e){
      if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW'){ e.preventDefault(); jump(); }
      if (e.code === 'KeyR'){ e.preventDefault(); start(); }
    }, false);
    window.addEventListener('pointerdown', function(){ jump(); }, {passive:true});
    retryBtn.addEventListener('click', start);

    var bgOffset = 0;
    function drawBackground(dt){
      if (!bgImg.complete || !bgImg.naturalWidth) {
        ctx.fillStyle = '#101010'; ctx.fillRect(0,0,canvas.width,canvas.height);
        return;
      }
      var speedPx = speed * 0.25;
      bgOffset = (bgOffset + speedPx * dt) % (bgImg.width || canvas.width);
      var ratio = Math.max(canvas.width / bgImg.width, canvas.height / bgImg.height);
      var w = (bgImg.width * ratio)|0;
      var h = (bgImg.height * ratio)|0;
      var y = (canvas.height - h) >> 1;
      var x1 = -bgOffset % w;
      ctx.drawImage(bgImg, x1, y, w, h);
      ctx.drawImage(bgImg, x1 + w, y, w, h);
    }
    function drawGround(){
      ctx.fillStyle = '#2a2a2a';
      ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);
      ctx.fillStyle = '#c0c0c0';
      var laneY = groundY + 14*DPR;
      for (var x = -40*DPR; x < canvas.width; x += 120*DPR){
        ctx.fillRect(x, laneY, 60*DPR, 4*DPR);
      }
    }
    function drawPlayer(){
      if (playerImg.complete && playerImg.naturalWidth){
        ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);
      } else {
        ctx.fillStyle = '#ff9';
        ctx.fillRect(player.x, player.y, player.w, player.h);
      }
    }
    function drawObstacle(o){
      if (o.type === 'corn'){
        var sprite = ensureCornSprite();
        if (sprite && sprite.width) ctx.drawImage(sprite, o.x, o.y, o.w, o.h);
        else { ctx.fillStyle = '#2ecc40'; ctx.fillRect(o.x, o.y, o.w, o.h); }
      } else {
        ctx.beginPath();
        var cx = o.x + o.w/2, cy = o.y + o.h/2, rx = o.w/2, ry = o.h/2;
        ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI*2);
        ctx.fillStyle = '#1d1d1d'; ctx.fill();
        ctx.strokeStyle = '#000'; ctx.lineWidth = 2*DPR; ctx.stroke();
      }
    }
    function rectsOverlap(ax,ay,aw,ah,bx,by,bw,bh){
      return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
    }

    function update(dt, t){
      speed += 6 * dt * DPR;

      player.vy += gravity * dt;
      player.y += player.vy * dt;
      if (player.y + player.h >= groundY){
        player.y = groundY - player.h; player.vy = 0; player.onGround = true;
      }

      if (t >= nextSpawn) spawnObstacle(t);
      for (var i = obstacles.length-1; i >= 0; i--){
        var o = obstacles[i];
        o.x -= speed * dt;
        if (o.x + o.w < -10) obstacles.splice(i,1);
        if (o.type === 'corn'){
          if (rectsOverlap(player.x+player.w*0.15, player.y+player.h*0.15, player.w*0.7, player.h*0.85, o.x, o.y, o.w, o.h)){
            die('corn'); return;
          }
        } else {
          var touchingGround = (player.y + player.h) >= groundY - 4*DPR;
          if (touchingGround && rectsOverlap(player.x+player.w*0.15, groundY-4*DPR, player.w*0.7, 6*DPR, o.x, o.y, o.w, o.h)){
            die('pothole'); return;
          }
        }
      }

      elapsed = (t - startTime)/1000;
      score += dt * 100;
      document.getElementById('time').textContent = elapsed.toFixed(1);
      document.getElementById('score').textContent = Math.floor(score);

      if (elapsed >= 30.0) {
        titleEl.textContent = 'Congratulations!';
        subEl.textContent = 'You survived 30 seconds! Taking you home…';
        overlay.classList.add('show');
        win();
      }
    }

    function loop(t){
      if (!running) return;
      now = t; var dt = Math.min(0.032, (now - last)/1000); last = now;
      drawBackground(dt); drawGround();
      for (var i=0;i<obstacles.length;i++) drawObstacle(obstacles[i]);
      drawPlayer(); update(dt, now);
      requestAnimationFrame(loop);
    }

    // Start regardless of images (avoids "black screen")
    var started = false;
    function forceStart(){ if (!started){ started = true; start(); } }
    window.addEventListener('load', forceStart, false);
    setTimeout(forceStart, 500);

    // If user taps black screen, also start (last-ditch)
    window.addEventListener('pointerdown', forceStart, {once:true, passive:true});
  })();
  </script>
</body>
</html>
